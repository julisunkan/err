<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Business Documents Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-shield-alt"></i> Admin Dashboard
            </a>

            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-shield"></i> Admin
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{{ url_for('messages') }}">
                            <i class="fas fa-envelope"></i> Messages
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('code_generator') }}">
                            <i class="fas fa-key"></i> Code Generator
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('index') }}">
                            <i class="fas fa-file-invoice"></i> Document Generator
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1>Admin Dashboard</h1>
                <p class="lead">Manage users, requests, and document uploads.</p>
            </div>
        </div>

        <div id="alert-container"></div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ users|length }}</h4>
                                <p class="mb-0">Total Users</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ pending_requests|length }}</h4>
                                <p class="mb-0">Pending Requests</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ recent_uploads|length }}</h4>
                                <p class="mb-0">Recent Uploads</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-upload fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ users|selectattr('is_verified', 'equalto', True)|list|length }}</h4>
                                <p class="mb-0">Verified Users</p>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs" id="adminTabs">
            <li class="nav-item">
                <a class="nav-link active" id="users-tab" data-bs-toggle="tab" href="#users">
                    <i class="fas fa-users"></i> Users
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="requests-tab" data-bs-toggle="tab" href="#requests">
                    <i class="fas fa-paper-plane"></i> Requests ({{ pending_requests|length }})
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="uploads-tab" data-bs-toggle="tab" href="#uploads">
                    <i class="fas fa-upload"></i> Recent Uploads
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="settings-tab" data-bs-toggle="tab" href="#settings">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="activity-tab" data-bs-toggle="tab" href="#activity">
                    <i class="fas fa-history"></i> Activity Logs
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="documents-tab" data-bs-toggle="tab" href="#documents">
                    <i class="fas fa-file-pdf"></i> Documents
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="backup-tab" data-bs-toggle="tab" href="#backup">
                    <i class="fas fa-download"></i> Backup & Restore
                </a>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- Users Tab -->
            <div class="tab-pane fade show active" id="users">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-users"></i> User Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Status</th>
                                        <th>Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user in users %}
                                    <tr>
                                        <td>{{ user.username }}</td>
                                        <td>{{ user.first_name }} {{ user.last_name }}</td>
                                        <td>{{ user.email }}</td>
                                        <td>
                                            {% if user.is_verified %}
                                            <span class="badge bg-success">Verified</span>
                                            {% else %}
                                            <span class="badge bg-warning">Unverified</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-primary" onclick="uploadForUser({{ user.id }}, '{{ user.first_name }} {{ user.last_name }}')">
                                                <i class="fas fa-upload"></i> Upload
                                            </button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="messageUser({{ user.id }}, '{{ user.first_name }} {{ user.last_name }}')">
                                                <i class="fas fa-envelope"></i> Message
                                            </button>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="editUser({{ user.id }}, '{{ user.username }}', '{{ user.email }}', '{{ user.first_name }}', '{{ user.last_name }}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                            {% if user.is_verified %}
                                            <button type="button" class="btn btn-sm btn-warning" onclick="toggleVerification({{ user.id }}, '{{ user.first_name }} {{ user.last_name }}', false)">
                                                <i class="fas fa-user-times"></i> Unverify
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-success" onclick="toggleVerification({{ user.id }}, '{{ user.first_name }} {{ user.last_name }}', true)">
                                                <i class="fas fa-user-check"></i> Verify
                                            </button>
                                            {% endif %}
                                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteUser({{ user.id }}, '{{ user.first_name }} {{ user.last_name }}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requests Tab -->
            <div class="tab-pane fade" id="requests">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-paper-plane"></i> Pending Requests</h5>
                    </div>
                    <div class="card-body">
                        {% if pending_requests %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>User</th>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in pending_requests %}
                                    <tr>
                                        <td>{{ request.user.first_name }} {{ request.user.last_name }}</td>
                                        <td>{{ request.title }}</td>
                                        <td>{{ request.description[:100] }}{% if request.description|length > 100 %}...{% endif %}</td>
                                        <td>{{ request.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-success" onclick="respondToRequest({{ request.id }}, 'approved')">
                                                <i class="fas fa-check"></i> Approve
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="respondToRequest({{ request.id }}, 'rejected')">
                                                <i class="fas fa-times"></i> Reject
                                            </button>
                                            <button type="button" class="btn btn-sm btn-info" onclick="viewFullRequest({{ request.id }}, '{{ request.title }}', '{{ request.description }}', '{{ request.user.first_name }} {{ request.user.last_name }}')">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5>No pending requests</h5>
                            <p class="text-muted">All requests have been processed.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Uploads Tab -->
            <div class="tab-pane fade" id="uploads">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-upload"></i> Recent Uploads</h5>
                    </div>
                    <div class="card-body">
                        {% if recent_uploads %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>File Name</th>
                                        <th>User</th>
                                        <th>Description</th>
                                        <th>Upload Date</th>
                                        <th>Downloads</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for upload in recent_uploads %}
                                    <tr>
                                        <td>{{ upload.original_filename }}</td>
                                        <td>{{ upload.user.first_name }} {{ upload.user.last_name }}</td>
                                        <td>{{ upload.description or 'No description' }}</td>
                                        <td>{{ upload.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>{{ upload.download_count }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-upload fa-3x text-muted mb-3"></i>
                            <h5>No uploads yet</h5>
                            <p class="text-muted">Upload files for users to see them here.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
             <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cog"></i> SMTP Settings</h5>
                    </div>
                    <div class="card-body">
                        <form id="smtpForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtpServer" class="form-label">SMTP Server</label>
                                        <input type="text" class="form-control" id="smtpServer" name="smtp_server" placeholder="smtp.gmail.com" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtpPort" class="form-label">SMTP Port</label>
                                        <input type="number" class="form-control" id="smtpPort" name="smtp_port" value="587" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtpUsername" class="form-label">SMTP Username</label>
                                        <input type="text" class="form-control" id="smtpUsername" name="smtp_username" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="smtpPassword" class="form-label">SMTP Password</label>
                                        <input type="password" class="form-control" id="smtpPassword" name="smtp_password" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="fromEmail" class="form-label">From Email</label>
                                        <input type="email" class="form-control" id="fromEmail" name="from_email" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="fromName" class="form-label">From Name</label>
                                        <input type="text" class="form-control" id="fromName" name="from_name" placeholder="Business Documents">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="useTls" name="use_tls" checked>
                                    <label class="form-check-label" for="useTls">
                                        Use TLS
                                    </label>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save SMTP Settings
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="testSmtpBtn">
                                    <i class="fas fa-paper-plane"></i> Test SMTP
                                </button>
                                <button type="button" class="btn btn-outline-info" id="loadSmtpBtn">
                                    <i class="fas fa-sync"></i> Load Current Settings
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Activity Logs Tab -->
            <div class="tab-pane fade" id="activity">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> User Activity Logs</h5>
                    </div>
                    <div class="card-body">
                        <div id="activity-logs-container">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <nav id="activity-pagination" class="mt-3" style="display: none;">
                            <ul class="pagination justify-content-center">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Generated Documents Tab -->
            <div class="tab-pane fade" id="documents">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-file-pdf"></i> Generated Documents</h5>
                    </div>
                    <div class="card-body">
                        <div id="documents-container">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup & Restore Tab -->
            <div class="tab-pane fade" id="backup">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-download"></i> Backup & Restore</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Manual Backup</h6>
                                <p class="text-muted">Create an immediate backup of database and files.</p>
                                <button type="button" class="btn btn-primary" id="createBackupBtn">
                                    <i class="fas fa-download"></i> Create Backup
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h6>Backup Settings</h6>
                                <form id="backupSettingsForm">
                                    <div class="mb-3">
                                        <label for="backupDirectory" class="form-label">Backup Directory</label>
                                        <input type="text" class="form-control" id="backupDirectory" name="backup_directory" placeholder="/path/to/backup/folder">
                                    </div>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                </form>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6>Automatic Backup</h6>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> Automatic backups are created every 24 hours and saved to the configured backup directory.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload File for User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">User</label>
                            <input type="text" class="form-control" id="uploadUserName" readonly>
                            <input type="hidden" id="uploadUserId" name="user_id">
                        </div>
                        <div class="mb-3">
                            <label for="uploadFile" class="form-label">File</label>
                            <input type="file" class="form-control" id="uploadFile" name="file" accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg" required>
                            <div class="form-text">Allowed file types: PDF, DOC, DOCX, TXT, PNG, JPG, JPEG (Max 16MB)</div>
                        </div>
                        <div class="mb-3">
                            <label for="uploadDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="uploadDescription" name="description" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Upload File</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Response Modal -->
    <div class="modal fade" id="responseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Respond to Request</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="responseForm">
                    <div class="modal-body">
                        <input type="hidden" id="responseRequestId">
                        <input type="hidden" id="responseStatus">
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <input type="text" class="form-control" id="responseStatusText" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="responseText" class="form-label">Response Message</label>
                            <textarea class="form-control" id="responseText" name="response" rows="4" placeholder="Enter your response to the user..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Response</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Request Modal -->
    <div class="modal fade" id="viewRequestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">User</label>
                        <input type="text" class="form-control" id="viewRequestUser" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" id="viewRequestTitle" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="viewRequestDescription" rows="6" readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Message</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="messageForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">To</label>
                            <input type="text" class="form-control" id="messageUserName" readonly>
                            <input type="hidden" id="messageUserId" name="recipient_id">
                        </div>
                        <div class="mb-3">
                            <label for="messageSubject" class="form-label">Subject</label>
                            <input type="text" class="form-control" id="messageSubject" name="subject" required>
                        </div>
                        <div class="mb-3">
                            <label for="messageContent" class="form-label">Message</label>
                            <textarea class="form-control" id="messageContent" name="content" rows="5" required placeholder="You can use HTML formatting in your message..."></textarea>
                            <div class="form-text">HTML formatting is supported (e.g., &lt;b&gt;bold&lt;/b&gt;, &lt;i&gt;italic&lt;/i&gt;, &lt;a href="..."&gt;links&lt;/a&gt;)</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Message</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- SMTP Test Modal -->
    <div class="modal fade" id="smtpTestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Test SMTP Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="smtpTestForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="testEmail" class="form-label">Test Email Address</label>
                            <input type="email" class="form-control" id="testEmail" name="test_email" required placeholder="Enter email to receive test message">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Send Test Email</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserForm">
                    <div class="modal-body">
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="editUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="editEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="editFirstName" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="editFirstName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editLastName" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="editLastName" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Colorful Footer -->
    <footer class="mt-5" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff9ff3 100%); color: white;">
        <div class="container py-4">
            <div class="row">
                <div class="col-md-3">
                    <h6><i class="fas fa-crown me-2"></i>Admin Panel</h6>
                    <p class="small">Comprehensive system administration and user management.</p>
                </div>
                <div class="col-md-3">
                    <h6><i class="fas fa-users me-2"></i>User Management</h6>
                    <div class="small">
                        <span class="d-block">Total Users: {{ users|length }}</span>
                        <span class="d-block text-white-50">Pending Requests: {{ pending_requests|length }}</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <h6><i class="fas fa-tools me-2"></i>Admin Tools</h6>
                    <div class="small">
                        <a href="/code-generator" class="text-white-50 text-decoration-none d-block">Code Generator</a>
                        <a href="/messages" class="text-white-50 text-decoration-none d-block">Messages</a>
                        <span class="text-white-50 d-block">SMTP Settings</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <h6><i class="fas fa-chart-line me-2"></i>System Status</h6>
                    <div class="small">
                        <span class="badge bg-success me-1">
                            <i class="fas fa-check me-1"></i>Online
                        </span>
                        <span class="badge bg-info">
                            <i class="fas fa-database me-1"></i>DB OK
                        </span>
                        <div class="mt-1 text-white-50">Admin since login</div>
                    </div>
                </div>
            </div>
            <hr class="my-3" style="border-color: rgba(255,255,255,0.2);">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0 small">&copy; 2025 Business Documents Generator - Admin Dashboard</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="small">
                        <span class="badge bg-light text-dark me-2">
                            <i class="fas fa-lock me-1"></i>Admin Access
                        </span>
                        <span class="badge bg-light text-dark">
                            <i class="fas fa-cogs me-1"></i>Full Control
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Show notification
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertClass = type === 'error' ? 'danger' : type;
            alertContainer.innerHTML = `
                <div class="alert alert-${alertClass} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const alert = alertContainer.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        // Upload for user
        function uploadForUser(userId, userName) {
            document.getElementById('uploadUserId').value = userId;
            document.getElementById('uploadUserName').value = userName;
            new bootstrap.Modal(document.getElementById('uploadModal')).show();
        }

        // Handle file upload
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const userId = document.getElementById('uploadUserId').value;

            try {
                const response = await fetch(`/api/upload-pdf/${userId}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
```python
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('Upload failed: ' + error.message, 'error');
            }
        });

        // Respond to request
        function respondToRequest(requestId, status) {
            document.getElementById('responseRequestId').value = requestId;
            document.getElementById('responseStatus').value = status;
            document.getElementById('responseStatusText').value = status.charAt(0).toUpperCase() + status.slice(1);
            new bootstrap.Modal(document.getElementById('responseModal')).show();
        }

        // Handle response submission
        document.getElementById('responseForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const requestId = document.getElementById('responseRequestId').value;
            const status = document.getElementById('responseStatus').value;
            const response = document.getElementById('responseText').value;

            try {
                const result = await fetch(`/api/respond-request/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status, response })
                });

                const data = await result.json();

                if (data.success) {
                    showAlert(data.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('responseModal')).hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (error) {
                showAlert('Response failed: ' + error.message, 'error');
            }
        });

        // View full request
        function viewFullRequest(requestId, title, description, userName) {
            document.getElementById('viewRequestUser').value = userName;
            document.getElementById('viewRequestTitle').value = title;
            document.getElementById('viewRequestDescription').value = description;
            new bootstrap.Modal(document.getElementById('viewRequestModal')).show();
        }

        // Message user
        function messageUser(userId, userName) {
            document.getElementById('messageUserId').value = userId;
            document.getElementById('messageUserName').value = userName;
            document.getElementById('messageSubject').value = '';
            document.getElementById('messageContent').value = '';
            new bootstrap.Modal(document.getElementById('messageModal')).show();
        }

        // Handle message sending
        document.getElementById('messageForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
                    this.reset();
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('Message failed: ' + error.message, 'error');
            }
        });

        // Toggle user verification
        function toggleVerification(userId, userName, newStatus) {
            if (confirm(`Are you sure you want to ${newStatus ? 'verify' : 'unverify'} ${userName}?`)) {
                fetch(`/api/admin/toggle-user-verification/${userId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showAlert(data.error, 'error');
                    }
                })
                .catch(error => {
                    showAlert('Verification update failed: ' + error.message, 'error');
                });
            }
        }

        // SMTP Settings functionality
        document.getElementById('loadSmtpBtn').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/admin/smtp-settings');
                const data = await response.json();

                if (data.success) {
                    const settings = data.settings;
                    document.getElementById('smtpServer').value = settings.smtp_server;
                    document.getElementById('smtpPort').value = settings.smtp_port;
                    document.getElementById('smtpUsername').value = settings.smtp_username;
                    document.getElementById('smtpPassword').value = settings.smtp_password === '••••••••' ? '' : settings.smtp_password;
                    document.getElementById('fromEmail').value = settings.from_email;
                    document.getElementById('fromName').value = settings.from_name;
                    document.getElementById('useTls').checked = settings.use_tls;

                    showAlert('SMTP settings loaded successfully', 'success');
                } else {
                    showAlert('Failed to load SMTP settings', 'error');
                }
            } catch (error) {
                showAlert('Error loading SMTP settings: ' + error.message, 'error');
            }
        });

        // Handle SMTP form submission
        document.getElementById('smtpForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData);
            data.use_tls = document.getElementById('useTls').checked;

            try {
                const response = await fetch('/api/admin/smtp-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('SMTP settings save failed: ' + error.message, 'error');
            }
        });

        // Test SMTP
        document.getElementById('testSmtpBtn').addEventListener('click', function() {
            new bootstrap.Modal(document.getElementById('smtpTestModal')).show();
        });

        // Handle SMTP test
        document.getElementById('smtpTestForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const testEmail = document.getElementById('testEmail').value;

            try {
                const response = await fetch('/api/admin/test-smtp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ test_email: testEmail })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('smtpTestModal')).hide();
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('SMTP test failed: ' + error.message, 'error');
            }
        });

        // Edit user
        function editUser(userId, username, email, firstName, lastName) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editEmail').value = email;
            document.getElementById('editFirstName').value = firstName;
            document.getElementById('editLastName').value = lastName;
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        // Delete user
        function deleteUser(userId, userName) {
            if (confirm(`Are you sure you want to delete user ${userName}? This action cannot be undone.`)) {
                fetch(`/api/admin/delete-user/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert(data.message, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showAlert(data.error, 'error');
                    }
                })
                .catch(error => {
                    showAlert('User deletion failed: ' + error.message, 'error');
                });
            }
        }

        // Handle edit user form submission
        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = document.getElementById('editUserId').value;
            const userData = {
                username: document.getElementById('editUsername').value,
                email: document.getElementById('editEmail').value,
                first_name: document.getElementById('editFirstName').value,
                last_name: document.getElementById('editLastName').value
            };

            try {
                const response = await fetch(`/api/admin/edit-user/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showAlert(result.error, 'error');
                }
            } catch (error) {
                showAlert('User update failed: ' + error.message, 'error');
            }
        });

        // Load SMTP settings on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loadSmtpBtn').click();
        });
    </script>
    <script>
        function openUploadModal(userId) {
            document.getElementById('uploadUserId').value = userId;
            new bootstrap.Modal(document.getElementById('uploadModal')).show();
        }

        function uploadFile() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            const userId = document.getElementById('uploadUserId').value;

            fetch(`/api/upload-pdf/${userId}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('File uploaded successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Upload failed');
            });
        }

        function respondToRequest(requestId, status) {
            const response = prompt(`Enter response for this ${status} request:`);
            if (response === null) return;

            fetch(`/api/respond-request/${requestId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    status: status,
                    response: response
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Response sent successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send response');
            });
        }

        // Admin functionality for user management
        function loadAllUsers() {
            fetch('/api/admin/users')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayUsersTable(data.users);
                    document.getElementById('usersCard').style.display = 'block';
                    document.getElementById('documentsCard').style.display = 'none';
                    document.getElementById('logsCard').style.display = 'none';
                }
            })
            .catch(error => console.error('Error loading users:', error));
        }

        function displayUsersTable(users) {
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Joined</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.first_name} ${user.last_name}</td>
                        <td>${user.email}</td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>${user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editUser(${user.id}, '${user.username}', '${user.email}', '${user.first_name}', '${user.last_name}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id}, '${user.username}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('usersTable').innerHTML = html;
        }

        function editUser(userId, username, email, firstName, lastName) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editEmail').value = email;
            document.getElementById('editFirstName').value = firstName;
            document.getElementById('editLastName').value = lastName;
            document.getElementById('editPassword').value = '';
            new bootstrap.Modal(document.getElementById('editUserModal')).show();
        }

        function saveUserEdit() {
            const userId = document.getElementById('editUserId').value;
            const data = {
                username: document.getElementById('editUsername').value,
                email: document.getElementById('editEmail').value,
                first_name: document.getElementById('editFirstName').value,
                last_name: document.getElementById('editLastName').value
            };

            const password = document.getElementById('editPassword').value;
            if (password) {
                // Update password separately
                fetch(`/api/admin/update-user-password/${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
            }

            fetch(`/api/admin/edit-user/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('User updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
                    loadAllUsers();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }

        function deleteUser(userId, username) {
            if (confirm(`Are you sure you want to delete user "${username}"? This action cannot be undone.`)) {
                fetch(`/api/admin/delete-user/${userId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('User deleted successfully!');
                        loadAllUsers();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        }

        function viewGeneratedDocuments() {
            fetch('/api/admin/generated-documents')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayDocumentsTable(data.documents);
                    document.getElementById('documentsCard').style.display = 'block';
                    document.getElementById('usersCard').style.display = 'none';
                    document.getElementById('logsCard').style.display = 'none';
                }
            });
        }

        function displayDocumentsTable(documents) {
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Document Type</th>
                                <th>Title</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            documents.forEach(doc => {
                html += `
                    <tr>
                        <td>${doc.user} (${doc.username})</td>
                        <td>${doc.document_type}</td>
                        <td>${doc.document_title}</td>
                        <td>${doc.created_at}</td>
                        <td>
                            <a href="/api/admin/download-generated-document/${doc.id}" class="btn btn-sm btn-primary">
                                <i class="fas fa-download"></i> Download
                            </a>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('documentsTable').innerHTML = html;
        }

        function viewActivityLogs() {
            fetch('/api/admin/activity-logs')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayLogsTable(data.logs);
                    document.getElementById('logsCard').style.display = 'block';
                    document.getElementById('documentsCard').style.display = 'none';
                    document.getElementById('usersCard').style.display = 'none';
                }
            });
        }

        function displayLogsTable(logs) {
            let html = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Activity</th>
                                <th>Description</th>
                                <th>IP Address</th>
                                <th>Date/Time</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            logs.forEach(log => {
                html += `
                    <tr>
                        <td>${log.user} (${log.username})</td>
                        <td>${log.activity_type}</td>
                        <td>${log.description}</td>
                        <td>${log.ip_address || 'N/A'}</td>
                        <td>${log.created_at}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('logsTable').innerHTML = html;
        }

        function backupDatabase() {
            if (confirm('Create backup of database and files?')) {
                fetch('/api/admin/backup-database', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Backup created successfully!');
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        }

        function showBackupSettings() {
            fetch('/api/admin/backup-settings')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('backupDirectory').value = data.backup_directory;
                    new bootstrap.Modal(document.getElementById('backupSettingsModal')).show();
                }
            });
        }

        function saveBackupSettings() {
            const backupDir = document.getElementById('backupDirectory').value;

            fetch('/api/admin/backup-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ backup_directory: backupDir })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Backup settings saved!');
                    bootstrap.Modal.getInstance(document.getElementById('backupSettingsModal')).hide();
                } else {
                    alert('Error: ' + data.error);
                }
            });
        }
    </script>
</body>
</html>